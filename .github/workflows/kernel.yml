name: Kernel-Builder

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: "Kernel repository URL"
        required: true
        default: "https://github.com/MistOS-psyche/kernel_xiaomi_sm8250.git"
      kernel_branch:
        description: "Kernel branch"
        required: true
        default: "E404-psyche"
      defconfig:
        description: "Kernel defconfig"
        required: true
        default: "vendor/psyche_defconfig"
      kernel_name:
        description: "Kernel name"
        required: true
        default: "Kernel"
      anykernel_repo:
        description: "AnyKernel repository URL"
        required: true
        default: "https://github.com/user25-dev/AnyKernel3"
      anykernel_branch:
        description: "AnyKernel branch"
        required: true
        default: "master"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      KERNEL_REPO: ${{ github.event.inputs.kernel_repo }}
      KERNEL_BRANCH: ${{ github.event.inputs.kernel_branch }}
      DEFCONFIG: ${{ github.event.inputs.defconfig }}
      KERNEL_NAME: ${{ github.event.inputs.kernel_name }}
      ANYKERNEL_REPO: ${{ github.event.inputs.anykernel_repo }}
      ANYKERNEL_BRANCH: ${{ github.event.inputs.anykernel_branch }}

    steps:

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y git wget build-essential bc bison flex \
          libssl-dev libelf-dev python3 unzip zip rsync libncurses-dev \
          lld xz-utils

      # -----------------------------
      # Toolchains
      # -----------------------------
      - name: Download Clang
        run: |
          mkdir clang
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r536225.tar.gz -O clang.tar.gz
          tar -xzf clang.tar.gz -C clang
          rm clang.tar.gz

      - name: Download GCC 64
        run: |
          mkdir gcc64
          wget https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/heads/master.tar.gz -O gcc64.tar.gz
          tar -xzf gcc64.tar.gz -C gcc64
          rm gcc64.tar.gz

      - name: Download GCC 32
        run: |
          mkdir gcc32
          wget https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/+archive/refs/heads/master.tar.gz -O gcc32.tar.gz
          tar -xzf gcc32.tar.gz -C gcc32
          rm gcc32.tar.gz

      # -----------------------------
      # Kernel
      # -----------------------------
      - name: Clone Kernel
        run: |
          git clone --recurse-submodules --depth=1 -b $KERNEL_BRANCH $KERNEL_REPO kernel

      - name: Build Kernel (Hybrid 4.19)
        working-directory: kernel
        run: |
          export ARCH=arm64
          export SUBARCH=arm64

          export PATH=$(pwd)/../clang/bin:$PATH
          export PATH=$(pwd)/../gcc64/bin:$PATH
          export PATH=$(pwd)/../gcc32/bin:$PATH

          export CROSS_COMPILE=aarch64-linux-android-
          export CROSS_COMPILE_ARM32=arm-linux-androideabi-
          export CLANG_TRIPLE=aarch64-linux-android-

          make O=out ARCH=arm64 CC=clang LLVM=1 $DEFCONFIG

          make -j$(nproc --all) O=out \
              ARCH=arm64 \
              CC=clang \
              LLVM=1 LLVM_IAS=1 \
              2>&1 | tee out/build.log

      # -----------------------------
      # Collect Outputs
      # -----------------------------
      - name: Collect Artifacts
        run: |
          mkdir release

          if [ -f "kernel/out/arch/arm64/boot/Image.gz-dtb" ]; then
            cp kernel/out/arch/arm64/boot/Image.gz-dtb release/
          else
            echo "Image.gz-dtb not found!"
            exit 1
          fi

          if [ -f "kernel/out/arch/arm64/boot/dtbo.img" ]; then
            cp kernel/out/arch/arm64/boot/dtbo.img release/
          fi

      # -----------------------------
      # AnyKernel Packaging
      # -----------------------------
      - name: Create AnyKernel3 Zip
        run: |
          git clone --depth=1 -b $ANYKERNEL_BRANCH $ANYKERNEL_REPO AnyKernel

          cp release/Image.gz-dtb AnyKernel/

          if [ -f "release/dtbo.img" ]; then
            cp release/dtbo.img AnyKernel/
            sed -i 's/^flash_dtbo=.*/flash_dtbo=1/' AnyKernel/anykernel.sh
          fi

          cd AnyKernel
          zip -r9 ${KERNEL_NAME}-earth-$(date +%Y%m%d).zip * -x .git README.md
          mv *.zip ../release/

      # -----------------------------
      # GitHub Release
      # -----------------------------
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: "${{ env.KERNEL_NAME }}-earth"
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
